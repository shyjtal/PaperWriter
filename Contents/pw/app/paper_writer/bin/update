#!/bin/sh
shopt -s nullglob
mkdir -p temp

while IFS='=' read -r key value; do
    if [[ "$key" == $fig_key_head* ]]; then  
        unset pages
        files=($resource_root/$resource_type/${value}.*)  
        [[ ! ${#files[@]} -eq 1 ]] && echo "$key must one to one with resource ${!key}.* (${#files[@]})" && exit 1
        
        file="${files[0]}"
        fig_key="${key#"${key%%[!$fig_key_head]*}"}"
        var_name="${fig_key}_fix"
        fix_var="${!var_name}"
        
        [[ $auto_fix == "true" ]] && fix_var=adapt

        [[ ! -z $fix_var ]] && pages=$(pdftk "$file" dump_data | grep NumberOfPages | awk '{print $2}')
        
        if [[ $fix_var == "adapt" && $pages > 1 ]]; then
            [[ $pages == 3 ]] && fix_var=ht
            [[ $pages == 2 ]] && fix_var=$auto_fix_2_pages
        fi

        if [[ "$fix_var" == "ht" ]]; then
            fix_opt=2-$(($pages-1))
        elif [[ "$fix_var" == "h" ]]; then
            fix_opt=2-$pages
        elif [[ "$fix_var" == "t" ]]; then
            fix_opt=1-$(($pages-1))
        fi
    
        [[ $pages > 1 ]] && pdftk "$file" cat $fix_opt output "$HOME/sh/app/paper_writer/temp/temp.pdf" && mv "temp/temp.pdf" "$file"
        
        cp "$file" $latex_root/$latex_fig_dir/$fig_key/

    fi

done < $HOME/sh/app/paper_writer/configs/$config_file
